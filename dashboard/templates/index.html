<!DOCTYPE html>
<html>
<head>
    <title>Sentinel Dashboard</title>
    <style>
        body {
            font-family: Arial;
        }
        .device-box {
            border: 1px solid #ccc;
            padding: 15px;
            margin: 10px;
            width: 350px;
            display: inline-block;
            vertical-align: top;
        }
        pre {
            background: #eee;
            padding: 5px;
        }

        /* Button styles */
        .btn {
            padding: 8px 14px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            color: white;
            font-weight: bold;
            margin-right: 8px;
        }

        .btn-on {
            background-color: green;
        }

        .btn-off {
            background-color: red;
        }
    </style>
</head>
<body>

<h1>Sentinel Dashboard</h1>

<div id="devices-container">
{% for name, device in devices.items() %}
    <div class="device-box" id="box-{{ name }}">
        <h3>{{ name }} ({{ device.class }})</h3>

        <strong>State:</strong>
        <pre id="state-{{ name }}">
{% if device.last_state %}
{{ device.last_state | tojson(indent=2) }}
{% else %}
No Data
{% endif %}
        </pre>

        <button class="btn btn-on" onclick="sendCmd('{{ name }}','on')" id="btn-on-{{ name }}">ON</button>
        <button class="btn btn-off" onclick="sendCmd('{{ name }}','off')" id="btn-off-{{ name }}">OFF</button>
    </div>
{% endfor %}
</div>

<script>
function sendCmd(device, action) {
    fetch(`/command/${device}/${action}`)
        .catch(err => console.error("Command error:", err));
}

// -------------------------------------------------------------
// SERVER-SENT EVENTS: LIVE STATE UPDATES
// -------------------------------------------------------------
const evt = new EventSource("/events");

evt.onmessage = function(event) {
    const update = JSON.parse(event.data);
    const name = update.name;
    const state = update.state;

    // 1. Update JSON display
    const pre = document.getElementById(`state-${name}`);
    if (pre) {
        pre.textContent = JSON.stringify(state, null, 2);
    }

    // 2. Update button colors
    if ("power" in state) {
        const onBtn = document.getElementById(`btn-on-${name}`);
        const offBtn = document.getElementById(`btn-off-${name}`);

        if (state.power === "on") {
            if (onBtn) onBtn.style.backgroundColor = "green";
            if (offBtn) offBtn.style.backgroundColor = "gray";
        } else {
            if (onBtn) onBtn.style.backgroundColor = "gray";
            if (offBtn) offBtn.style.backgroundColor = "red";
        }
    }

    if ("position" in state) {
        // Example: garage door position â†’ highlight open/close differently if desired
        // For now, do nothing special.
    }
};
</script>

</body>
</html>
